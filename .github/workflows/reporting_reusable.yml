name: Aggregate RAMLs Report (Last Two Tags)

on:
  workflow_dispatch:
    inputs:
      repos_json:
        description: 'JSON-массив репозиториев: ["owner/a","owner/b"]'
        required: true
        default: '["owner/a","owner/b"]'
      path:
        description: 'Каталог для диффа'
        required: true
        default: 'ramls'

permissions:
  contents: read

jobs:
  per-repo:
    name: Build per-repo report
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(inputs.repos_json) }}

    steps:
      - name: Debug repo name
        run: echo "Repo to checkout: ${{ matrix.repo }}"

      - name: Checkout ${{ matrix.repo }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Pick last two tags
        id: tags
        shell: bash
        run: |
          mapfile -t TAGS < <(git tag --sort=-creatordate | head -n 2)
          if [[ "${#TAGS[@]}" -lt 2 ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No enough tags in ${{ matrix.repo }}"
            exit 0
          fi
          echo "to=${TAGS[0]}"   >> $GITHUB_OUTPUT
          echo "from=${TAGS[1]}" >> $GITHUB_OUTPUT

      # === Формируем БЕЗОПАСНЫЕ имена и кладём в GITHUB_ENV ===
      - name: Compute safe names (no slashes)
        if: steps.tags.outputs.skip != 'true'
        shell: bash
        run: |
          set -e
          REPO="${{ matrix.repo }}"              # owner/repo
          SAFE="${REPO//\//__}"                  # owner__repo
          FOLDER="${{ inputs.path }}"
          # уберём любые потенциально плохие символы
          SAFE_CLEAN="$(echo "$SAFE" | tr -cd 'A-Za-z0-9._-')"
          OUT_FILE="${SAFE_CLEAN}-${FOLDER}-tags-diff.md"
          ARTIFACT_NAME="${SAFE_CLEAN}-${FOLDER}-tags-report"

          echo "SAFE_REPO=$SAFE_CLEAN" >> $GITHUB_ENV
          echo "OUT_FILE=$OUT_FILE" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV

          echo "DEBUG SAFE_REPO=$SAFE_CLEAN"
          echo "DEBUG OUT_FILE=$OUT_FILE"
          echo "DEBUG ARTIFACT_NAME=$ARTIFACT_NAME"

      - name: Build repo report
        if: steps.tags.outputs.skip != 'true'
        shell: bash
        run: |
          FROM="${{ steps.tags.outputs.from }}"
          TO="${{ steps.tags.outputs.to }}"
          FOLDER="${{ inputs.path }}"
          OUT="${OUT_FILE}"

          echo "# ${FOLDER} changes in ${{ matrix.repo }}" > "$OUT"
          echo "- From: $FROM" >> "$OUT"
          echo "- To:   $TO"   >> "$OUT"
          echo "" >> "$OUT"

          CHANGES=$(git diff --name-status "$FROM" "$TO" -- "$FOLDER/" || true)
          if [[ -z "$CHANGES" ]]; then
            echo "_No changes in \`$FOLDER/\`_" >> "$OUT"
          else
            echo "| Status | File |" >> "$OUT"
            echo "|------:|------|" >> "$OUT"
            while IFS=$'\t' read -r st file; do
              [[ -z "$st" ]] && continue
              echo "| \`$st\` | \`$file\` |" >> "$OUT"
            done <<< "$CHANGES"
          fi

      - name: Safety check (artifact name)
        if: steps.tags.outputs.skip != 'true'
        shell: bash
        run: |
          echo "Will upload artifact: ${ARTIFACT_NAME}"
          case "${ARTIFACT_NAME}" in
            */*|\**|\?*|*:*|*\"*|*<*|*>**|\|*|*\\*|*$'\r'*|*$'\n'*)
              echo "Invalid character found in ARTIFACT_NAME: '${ARTIFACT_NAME}'"
              exit 1;;
          esac

      - name: Upload per-repo artifact
        if: steps.tags.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          # Используем ТОЛЬКО env, вычисленный выше
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.OUT_FILE }}

  aggregate:
    name: Combine reports
    runs-on: ubuntu-latest
    needs: per-repo

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Build combined report
        id: comb
        shell: bash
        run: |
          OUT="combined-${{ inputs.path }}-tags-report.md"
          echo "# Combined \`${{ inputs.path }}\` changes (last two tags)" > "$OUT"
          echo "" >> "$OUT"
          shopt -s globstar nullglob
          found=0
          for f in reports/**/**/*.md reports/**/*.md; do
            found=1
            echo "## $(basename "$f")" >> "$OUT"
            echo "" >> "$OUT"
            cat "$f" >> "$OUT"
            echo "" >> "$OUT"
            echo "---" >> "$OUT"
            echo "" >> "$OUT"
          done
          if [[ $found -eq 0 ]]; then
            echo "_No per-repo reports were produced (probably missing tags)_" >> "$OUT"
          fi
          echo "out=$OUT" >> $GITHUB_OUTPUT

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: combined-${{ inputs.path }}-tags-report
          path: ${{ steps.comb.outputs.out }}
