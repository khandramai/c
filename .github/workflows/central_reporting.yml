name: Centralized Schema Reporting

on:
  workflow_dispatch:
    inputs:
      repo_a_path:
        description: 'Путь к папке схемы в репозитории A (от корня репо)'
        required: true
        default: 'schemas/a' # Пример: измените на ваш реальный путь
      repo_b_path:
        description: 'Путь к папке схемы в репозитории B (от корня репо)'
        required: true
        default: 'schemas/b' # Пример: измените на ваш реальный путь

jobs:
  generate_combined_report:
    runs-on: ubuntu-latest

    # Требуется разрешение для записи (для создания артефакта)
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout Central Repository (c)
        uses: actions/checkout@v4
        with:
          path: c-repo # Клонируем в отдельную папку

      # ----- Обработка репозитория A -----
      - name: Checkout Module A
        uses: actions/checkout@v4
        with:
          repository: khandramai/a # Замените 'your_org/a' на реальный путь
          token: ${{ secrets.REPO_ACCESS_TOKEN }} # Используем PAT для доступа к другому репо
          path: a-repo
          fetch-depth: 0 # Требуется для тегов

      - name: Get A Tags and Generate Report
        id: report_a
        working-directory: ./a-repo
        run: |
          echo "--- Отчет для репозитория A (${{ github.event.inputs.repo_a_path }}) ---" > ../report_a.md
          
          # Получение тегов в репозитории A
          CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "latest")
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CURRENT_TAG^ 2>/dev/null || echo "initial")
          
          echo "Текущий тег: $CURRENT_TAG" >> ../report_a.md
          echo "Предыдущий тег: $PREVIOUS_TAG" >> ../report_a.md
          
          # Логика определения дифференса (ВАШ КОД ИЗ ИСХОДНОГО WORKFLOW)
          # Здесь должен быть вызов вашего скрипта/логики, 
          # который сравнивает схемы в папке ${{ github.event.inputs.repo_a_path }}
          # между тегами $PREVIOUS_TAG и $CURRENT_TAG
          #
          # Пример (замените на ваш реальный код):
          # git diff $PREVIOUS_TAG $CURRENT_TAG -- ${{ github.event.inputs.repo_a_path }} >> ../report_a.md
          echo "Сравнение схем в папке ${{ github.event.inputs.repo_a_path }} (должен быть ваш скрипт):" >> ../report_a.md
          echo "- Обнаружены 5 изменений." >> ../report_a.md
          echo "---" >> ../report_a.md

      # ----- Обработка репозитория B -----
      - name: Checkout Module B
        uses: actions/checkout@v4
        with:
          repository: khandramai/b # Замените 'your_org/b' на реальный путь
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: b-repo
          fetch-depth: 0 # Требуется для тегов

      - name: Get B Tags and Generate Report
        id: report_b
        working-directory: ./b-repo
        run: |
          echo "--- Отчет для репозитория B (${{ github.event.inputs.repo_b_path }}) ---" > ../report_b.md
          
          # Получение тегов в репозитории B
          CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "latest")
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CURRENT_TAG^ 2>/dev/null || echo "initial")
          
          echo "Текущий тег: $CURRENT_TAG" >> ../report_b.md
          echo "Предыдущий тег: $PREVIOUS_TAG" >> ../report_b.md
          
          # Логика определения дифференса (ВАШ КОД ИЗ ИСХОДНОГО WORKFLOW)
          # Здесь должен быть вызов вашего скрипта/логики
          echo "Сравнение схем в папке ${{ github.event.inputs.repo_b_path }} (должен быть ваш скрипт):" >> ../report_b.md
          echo "- Обнаружены 2 изменения." >> ../report_b.md
          echo "---" >> ../report_b.md

      # ----- Объединение и публикация отчета -----
      - name: Combine Reports
        run: |
          # Создаем финальный объединенный отчет
          echo "# Центральный отчет об изменениях схем" > combined_report.md
          date >> combined_report.md
          echo "" >> combined_report.md
          
          cat report_a.md >> combined_report.md
          echo "" >> combined_report.md
          cat report_b.md >> combined_report.md
          
          cat combined_report.md # Вывод в лог

      - name: Upload Combined Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: centralized-schema-report-${{ github.sha }}
          path: combined_report.md
          retention-days: 5