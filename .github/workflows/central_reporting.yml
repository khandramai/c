name: Centralized Schema Reporting

on:
  workflow_dispatch:
    inputs:
      repo_a_name:
        description: 'Имя репозитория A'
        required: true
        default: 'a'
      repo_b_name:
        description: 'Имя репозитория B'
        required: true
        default: 'b'

jobs:
  generate_combined_report:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout Central Repo (c) to get Action logic
        uses: actions/checkout@v4

      - name: Configure Git
        run: git config --global fetch.prune true

      # ==========================================================
      #                     Обработка Репозитория A
      # ==========================================================
      - name: Checkout Module A (khandramai/a)
        uses: actions/checkout@v4
        with:
          repository: khandramai/${{ github.event.inputs.repo_a_name }}
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: a-repo
          fetch-depth: 0

      - name: Get A Tags (Current and Previous)
        id: tags_a
        working-directory: ./a-repo
        run: |
          # Текущий референс: последний тег или HEAD
          CURRENT_REF=$(git describe --tags --abbrev=0 2>/dev/null || echo ${{ github.sha }})
          
          # Находим SHA второго с конца тега.
          PREVIOUS_TAG_HASH=$(git rev-list --tags --max-count=2 --skip=1 --date-order | head -n 1)
          
          if [ -z "$PREVIOUS_TAG_HASH" ]; then
              # Если тегов меньше двух, используем SHA первого коммита
              PREVIOUS_REF=$(git rev-list --max-parents=0 HEAD | head -n 1)
          else
              # Используем SHA второго с конца тега
              PREVIOUS_REF=$(git describe --tags --abbrev=0 ${PREVIOUS_TAG_HASH} 2>/dev/null)
          fi

          echo "current-ref=$CURRENT_REF" >> $GITHUB_OUTPUT
          echo "previous-ref=$PREVIOUS_REF" >> $GITHUB_OUTPUT

      - name: Compare A Schemas and Generate Report
        id: compare_a
        uses: ./.github/actions/compare-schemas
        with:
          current-ref: ${{ steps.tags_a.outputs.current-ref }}
          previous-ref: ${{ steps.tags_a.outputs.previous-ref }}
          schemas-path: 'ramls'
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}/a-repo

      # ==========================================================
      #                     Обработка Репозитория B
      # ==========================================================
      - name: Checkout Module B (khandramai/b)
        uses: actions/checkout@v4
        with:
          repository: khandramai/${{ github.event.inputs.repo_b_name }}
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: b-repo
          fetch-depth: 0

      - name: Get B Tags (Current and Previous)
        id: tags_b
        working-directory: ./b-repo
        run: |
          CURRENT_REF=$(git describe --tags --abbrev=0 2>/dev/null || echo ${{ github.sha }})
          
          PREVIOUS_TAG_HASH=$(git rev-list --tags --max-count=2 --skip=1 --date-order | head -n 1)
          
          if [ -z "$PREVIOUS_TAG_HASH" ]; then
              PREVIOUS_REF=$(git rev-list --max-parents=0 HEAD | head -n 1)
          else
              PREVIOUS_REF=$(git describe --tags --abbrev=0 ${PREVIOUS_TAG_HASH} 2>/dev/null)
          fi

          echo "current-ref=$CURRENT_REF" >> $GITHUB_OUTPUT
          echo "previous-ref=$PREVIOUS_REF" >> $GITHUB_OUTPUT

      - name: Compare B Schemas and Generate Report
        id: compare_b
        uses: ./.github/actions/compare-schemas
        with:
          current-ref: ${{ steps.tags_b.outputs.current-ref }}
          previous-ref: ${{ steps.tags_b.outputs.previous-ref }}
          schemas-path: 'ramls'
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}/b-repo

      # ==========================================================
      #                 Объединение и Артефакт
      # ==========================================================
      - name: Combine Reports
        run: |
          {
            echo "# 🌟 Центральный Отчет Об Изменениях Схем"
            echo "Дата запуска: $(date)"
            echo ""
          
            echo "## Модуль A: ${{ github.event.inputs.repo_a_name }}"
            echo "Сравнение: \`${{ steps.tags_a.outputs.previous-ref }}...${{ steps.tags_a.outputs.current-ref }}\`"
            echo "${{ steps.compare_a.outputs.report }}"
            echo ""
          
            echo "## Модуль B: ${{ github.event.inputs.repo_b_name }}"
            echo "Сравнение: \`${{ steps.tags_b.outputs.previous-ref }}...${{ steps.tags_b.outputs.current-ref }}\`"
            echo "${{ steps.compare_b.outputs.report }}"
          } > combined_report.md

      - name: Upload Combined Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: centralized-schema-report-${{ github.sha }}
          path: combined_report.md
          retention-days: 7