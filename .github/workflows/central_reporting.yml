name: Centralized Schema Reporting

on:
  workflow_dispatch:
    inputs:
      repo_a_name:
        description: 'Ð˜Ð¼Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ A'
        required: true
        default: 'a'
      repo_b_name:
        description: 'Ð˜Ð¼Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ B'
        required: true
        default: 'b'

jobs:
  generate_combined_report:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout Central Repo (c) to get Action logic
        # ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ°Ð¼Ð¾Ð³Ð¾ ÑÐµÐ±Ñ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð¼ÐµÑ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Action logic
        uses: actions/checkout@v4

      - name: Configure Git
        run: git config --global fetch.prune true

      # ==========================================================
      #                     ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ A
      # ==========================================================
      - name: Checkout Module A (khandramai/a)
        uses: actions/checkout@v4
        with:
          repository: khandramai/${{ github.event.inputs.repo_a_name }}
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: a-repo
          fetch-depth: 0

      - name: Get A Tags (Current and Previous)
        id: tags_a
        working-directory: ./a-repo
        run: |
          CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "latest")
          
          # Ð›Ð¾Ð³Ð¸ÐºÐ° Ð´Ð»Ñ Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ñ ÐºÐ¾Ð½Ñ†Ð° Ñ‚ÐµÐ³Ð°. Ð•ÑÐ»Ð¸ Ñ‚ÐµÐ³Ð¾Ð² Ð¼ÐµÐ½ÑŒÑˆÐµ Ð´Ð²ÑƒÑ…, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ„Ð»Ð°Ð³ NOT_FOUND.
          PREVIOUS_TAG_HASH=$(git rev-list --tags --max-count=2 --skip=1 --date-order | head -n 1)
          if [ -z "$PREVIOUS_TAG_HASH" ]; then
              PREVIOUS_REF="NOT_FOUND" 
          else
              PREVIOUS_REF=$(git describe --tags --abbrev=0 ${PREVIOUS_TAG_HASH} 2>/dev/null)
          fi

          echo "current-ref=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "previous-ref=$PREVIOUS_REF" >> $GITHUB_OUTPUT

      - name: Compare A Schemas and Generate Report
        id: compare_a
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Action: ./.github/actions/compare-schemas
        uses: ./.github/actions/compare-schemas
        with:
          current-ref: ${{ steps.tags_a.outputs.current-ref }}
          previous-ref: ${{ steps.tags_a.outputs.previous-ref }}
          schemas-path: 'ramls'
        # ÐŸÐ•Ð Ð•ÐžÐŸÐ Ð•Ð”Ð•Ð›Ð¯Ð•Ðœ Ð ÐÐ‘ÐžÐ§Ð£Ð® ÐžÐ‘Ð›ÐÐ¡Ð¢Ð¬ Ð´Ð»Ñ Action
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}/a-repo

      # ==========================================================
      #                     ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ B
      # ==========================================================
      - name: Checkout Module B (khandramai/b)
        uses: actions/checkout@v4
        with:
          repository: khandramai/${{ github.event.inputs.repo_b_name }}
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: b-repo
          fetch-depth: 0

      - name: Get B Tags (Current and Previous)
        id: tags_b
        working-directory: ./b-repo
        run: |
          CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "latest")
          
          PREVIOUS_TAG_HASH=$(git rev-list --tags --max-count=2 --skip=1 --date-order | head -n 1)
          if [ -z "$PREVIOUS_TAG_HASH" ]; then
              PREVIOUS_REF="NOT_FOUND" 
          else
              PREVIOUS_REF=$(git describe --tags --abbrev=0 ${PREVIOUS_TAG_HASH} 2>/dev/null)
          fi

          echo "current-ref=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "previous-ref=$PREVIOUS_REF" >> $GITHUB_OUTPUT

      - name: Compare B Schemas and Generate Report
        id: compare_b
        uses: ./.github/actions/compare-schemas
        with:
          current-ref: ${{ steps.tags_b.outputs.current-ref }}
          previous-ref: ${{ steps.tags_b.outputs.previous-ref }}
          schemas-path: 'ramls'
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}/b-repo

      # ==========================================================
      #                 ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ð¸ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚
      # ==========================================================
      - name: Combine Reports
        run: |
          {
            echo "# ðŸŒŸ Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐžÑ‚Ñ‡ÐµÑ‚ ÐžÐ± Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ… Ð¡Ñ…ÐµÐ¼"
            echo "Ð”Ð°Ñ‚Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°: $(date)"
            echo ""
          
            echo "## ÐœÐ¾Ð´ÑƒÐ»ÑŒ A: ${{ github.event.inputs.repo_a_name }}"
            echo "Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ: \`${{ steps.tags_a.outputs.previous-ref }}...${{ steps.tags_a.outputs.current-ref }}\`"
            echo "${{ steps.compare_a.outputs.report }}"
            echo ""
          
            echo "## ÐœÐ¾Ð´ÑƒÐ»ÑŒ B: ${{ github.event.inputs.repo_b_name }}"
            echo "Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ: \`${{ steps.tags_b.outputs.previous-ref }}...${{ steps.tags_b.outputs.current-ref }}\`"
            echo "${{ steps.compare_b.outputs.report }}"
          } > combined_report.md

      - name: Upload Combined Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: centralized-schema-report-${{ github.sha }}
          path: combined_report.md
          retention-days: 7