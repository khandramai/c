name: Генерация общего отчета по схемам

on:
  workflow_dispatch:
    inputs:
      repository_a:
        description: 'Репозиторий A (owner/repo)'
        required: true
        default: 'khandramai/a' # <-- Обновлено
      repository_b:
        description: 'Репозиторий B (owner/repo)'
        required: true
        default: 'khandramai/b' # <-- Обновлено
      schema_path_a:
        description: 'Путь к схемам в A (от корня)'
        required: true
        default: 'schemas'
      schema_path_b:
        description: 'Путь к схемам в B (от корня)'
        required: true
        default: 'schemas'

jobs:
  generate_reports:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Установка jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # --- Определение тегов (Устойчивая логика) ---
      # Шаги tags_a и tags_b (используют GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }})
      # ... (Оставляем логику из предыдущего ответа с проверкой ответа API)

      # --- Клонирование репозиториев по тегам (A и B) ---
      # ... (Оставляем шаги checkout с использованием ${{ secrets.REPO_ACCESS_TOKEN }})

      # --- Запуск логики сравнения (A) ---
      - name: Генерация отчета A
        id: report_a
        run: |
          CURRENT_PATH="repo_a/current/${{ github.event.inputs.schema_path_a }}"
          PREVIOUS_PATH="repo_a/previous/${{ github.event.inputs.schema_path_a }}"
          
          # Вставьте вашу логику сравнения здесь (например, diff -r $CURRENT_PATH $PREVIOUS_PATH)
          REPORT_A=$(diff -r $CURRENT_PATH $PREVIOUS_PATH || true)
          
          echo "## Отчет A (${{ github.event.inputs.repository_a }})" > report_a.txt
          # ... (Формирование отчета A)

      # --- Запуск логики сравнения (B) ---
      - name: Генерация отчета B
        id: report_b
        run: |
          CURRENT_PATH="repo_b/current/${{ github.event.inputs.schema_path_b }}"
          PREVIOUS_PATH="repo_b/previous/${{ github.event.inputs.schema_path_b }}"
          
          # Вставьте вашу логику сравнения здесь
          REPORT_B=$(diff -r $CURRENT_PATH $PREVIOUS_PATH || true)
          
          echo "## Отчет B (${{ github.event.inputs.repository_b }})" > report_b.txt
          # ... (Формирование отчета B)

      # --- Объединение и Загрузка ---
      - name: Объединение отчетов
        run: |
          echo "# Общий отчет об изменениях в схемах" > final_report.md
          cat report_a.txt >> final_report.md
          echo "" >> final_report.md
          cat report_b.txt >> final_report.md

      - name: Загрузка артефакта
        uses: actions/upload-artifact@v4
        with:
          name: Общий_Отчет_Схем_${{ github.run_id }}
          path: final_report.md
          retention-days: 7