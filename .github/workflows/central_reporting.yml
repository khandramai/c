name: Centralized Schema Reporting

on:
  workflow_dispatch:
    inputs:
      repo_a_name:
        description: 'Ð˜Ð¼Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ A'
        required: true
        default: 'a'
      repo_b_name:
        description: 'Ð˜Ð¼Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ B'
        required: true
        default: 'b'

jobs:
  generate_combined_report:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout Central Repo (c) to get Action logic
        uses: actions/checkout@v4

      - name: Configure Git
        run: git config --global fetch.prune true

      # ==========================================================
      #                     ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ A
      # ==========================================================
      - name: Checkout Module A (khandramai/a)
        uses: actions/checkout@v4
        with:
          repository: khandramai/${{ github.event.inputs.repo_a_name }}
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: a-repo
          fetch-depth: 0

      - name: Get A Tags (Current and Previous)
        id: tags_a
        working-directory: ./a-repo
        run: |
          # Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ€ÐµÑ„ÐµÑ€ÐµÐ½Ñ: Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ‚ÐµÐ³ Ð¸Ð»Ð¸ HEAD
          CURRENT_REF=$(git describe --tags --abbrev=0 2>/dev/null || echo ${{ github.sha }})
          
          # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ SHA Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ñ ÐºÐ¾Ð½Ñ†Ð° Ñ‚ÐµÐ³Ð°.
          PREVIOUS_TAG_HASH=$(git rev-list --tags --max-count=2 --skip=1 --date-order | head -n 1)
          
          if [ -z "$PREVIOUS_TAG_HASH" ]; then
              # Ð•ÑÐ»Ð¸ Ñ‚ÐµÐ³Ð¾Ð² Ð¼ÐµÐ½ÑŒÑˆÐµ Ð´Ð²ÑƒÑ…, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ SHA Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
              PREVIOUS_REF=$(git rev-list --max-parents=0 HEAD | head -n 1)
          else
              # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ SHA Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ñ ÐºÐ¾Ð½Ñ†Ð° Ñ‚ÐµÐ³Ð°
              PREVIOUS_REF=$(git describe --tags --abbrev=0 ${PREVIOUS_TAG_HASH} 2>/dev/null)
          fi

          echo "current-ref=$CURRENT_REF" >> $GITHUB_OUTPUT
          echo "previous-ref=$PREVIOUS_REF" >> $GITHUB_OUTPUT

      - name: Compare A Schemas and Generate Report
        id: compare_a
        uses: ./.github/actions/compare-schemas
        with:
          current-ref: ${{ steps.tags_a.outputs.current-ref }}
          previous-ref: ${{ steps.tags_a.outputs.previous-ref }}
          schemas-path: 'ramls'
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}/a-repo

      # ==========================================================
      #                     ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ B
      # ==========================================================
      - name: Checkout Module B (khandramai/b)
        uses: actions/checkout@v4
        with:
          repository: khandramai/${{ github.event.inputs.repo_b_name }}
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: b-repo
          fetch-depth: 0

      - name: Get B Tags (Current and Previous)
        id: tags_b
        working-directory: ./b-repo
        run: |
          CURRENT_REF=$(git describe --tags --abbrev=0 2>/dev/null || echo ${{ github.sha }})
          
          PREVIOUS_TAG_HASH=$(git rev-list --tags --max-count=2 --skip=1 --date-order | head -n 1)
          
          if [ -z "$PREVIOUS_TAG_HASH" ]; then
              PREVIOUS_REF=$(git rev-list --max-parents=0 HEAD | head -n 1)
          else
              PREVIOUS_REF=$(git describe --tags --abbrev=0 ${PREVIOUS_TAG_HASH} 2>/dev/null)
          fi

          echo "current-ref=$CURRENT_REF" >> $GITHUB_OUTPUT
          echo "previous-ref=$PREVIOUS_REF" >> $GITHUB_OUTPUT

      - name: Compare B Schemas and Generate Report
        id: compare_b
        uses: ./.github/actions/compare-schemas
        with:
          current-ref: ${{ steps.tags_b.outputs.current-ref }}
          previous-ref: ${{ steps.tags_b.outputs.previous-ref }}
          schemas-path: 'ramls'
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}/b-repo

      # ==========================================================
      #                 ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ð¸ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚
      # ==========================================================
      - name: Combine Reports
        run: |
          {
            echo "# ðŸŒŸ Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐžÑ‚Ñ‡ÐµÑ‚ ÐžÐ± Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ… Ð¡Ñ…ÐµÐ¼"
            echo "Ð”Ð°Ñ‚Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°: $(date)"
            echo ""
          
            echo "## ÐœÐ¾Ð´ÑƒÐ»ÑŒ A: ${{ github.event.inputs.repo_a_name }}"
            echo "Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ: \`${{ steps.tags_a.outputs.previous-ref }}...${{ steps.tags_a.outputs.current-ref }}\`"
            echo "${{ steps.compare_a.outputs.report }}"
            echo ""
          
            echo "## ÐœÐ¾Ð´ÑƒÐ»ÑŒ B: ${{ github.event.inputs.repo_b_name }}"
            echo "Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ: \`${{ steps.tags_b.outputs.previous-ref }}...${{ steps.tags_b.outputs.current-ref }}\`"
            echo "${{ steps.compare_b.outputs.report }}"
          } > combined_report.md

      - name: Upload Combined Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: centralized-schema-report-${{ github.sha }}
          path: combined_report.md
          retention-days: 7