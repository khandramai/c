name: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º

on:
  workflow_call:
    inputs:
      pull_request_number:
        required: true
        type: number
      head_sha:
        required: true
        type: string
      base_sha:
        required: true
        type: string
      schema_path:
        required: true
        type: string
        default: 'schemas'

jobs:
  check_diff_and_comment:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Base Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_sha }}
          path: base
          fetch-depth: 0

      - name: Checkout Head Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.head_sha }}
          path: head
          fetch-depth: 0

      - name: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ö–µ–º –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
        id: diff
        run: |
          CURRENT_PATH="head/${{ inputs.schema_path }}"
          PREVIOUS_PATH="base/${{ inputs.schema_path }}"
          
          # –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–£ –õ–û–ì–ò–ö–£ –°–†–ê–í–ù–ï–ù–ò–Ø!
          DIFF_OUTPUT=$(diff -r $CURRENT_PATH $PREVIOUS_PATH || true)
          
          if [ -z "$DIFF_OUTPUT" ]; then
            REPORT="üéâ –ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å—Ö–µ–º–∞—Ö –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ."
            HAS_CHANGES="false"
          else
            REPORT="## –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ö–µ–º–∞—Ö (PR #${{ inputs.pull_request_number }}):\n\n\`\`\`diff\n$DIFF_OUTPUT\n\`\`\`"
            # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –≤ GITHUB_OUTPUT
            REPORT="${REPORT//'%'/'%25'}" 
            REPORT="${REPORT//$'\n'/'%0A'}" 
            REPORT="${REPORT//$'\r'/'%0D'}" 
            HAS_CHANGES="true"
          fi
          
          echo "report_body=$REPORT" >> $GITHUB_OUTPUT
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

      - name: –û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR
        if: steps.diff.outputs.has_changes == 'true'
        uses: thollander/comment-action@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ inputs.pull_request_number }}
          message: ${{ steps.diff.outputs.report_body }}